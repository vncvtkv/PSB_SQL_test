# Тестовое задание для ПСБ Банка

## Быстрый старт
При написании запросов использавался **PostgreSQL**.


1.  **Клонируйте репозиторий:**

    ```bash
    git clone https://github.com/vncvtkv/PSB_SQL_test.git
    cd PSB_SQL_test
    ```
2.  **Запустите бд с помощью Docker Compose:**

    ```bash
    docker compose up --build
    ```
    *   Эта команда автоматически запустит базу данных **Postgres**.
3.  **Подключение через DBeaver:**
    1. Создано новое подключение к **Postgres**
    2. Указаны параметры:
        
        * Хост: localhost
        
        * Порт: 5432

        * База данных: psb

        * Пользователь: postgres

        * Пароль: postgres

# Условия задач
## Задача 1

Есть таблица **Table** с покупками клиентов, где
**CLIENT_ID** – это идентификатор клиента,
**AMOUNT** – сумма совершенной покупки,
**DATE** – дата совершенной транзакции.

**Необходимо** написать запросы, которые покажут:

**1.** Количество клиентов магазина;

**2.** За январь 2023 года для каждого клиента сумму всех его покупок, среднюю сумму
покупки, максимальный размер покупки (самую дорогую);

**3.** Клиентов, которые совершили больше 2 покупок и количество совершенных покупок.
Результат необходимо отразить по убыванию количества совершенных покупок.

**Решение**:
[SQL-запросы для решения первой задачи](https://github.com/vncvtkv/PSB_SQL_test/blob/dev/scripts/psb_1.sql)

## Задача 2
Есть две таблицы:
* **credit (credit_id, issued_date)** – таблица со всеми выданными кредитами;
* **credit_calculations (credit_id, calculation_date, status)** – таблица с описанием каждого дня жизни кредита. Поле status может принимать значения: **ACTIVE** (займ активен), **EXPIRED** (займ в просрочке), **COMPLETED** (займ закрылся, после этого записи в таблице **credit_calculations** по данному кредиту прекращаются).

**Необходимо**:

**1.** Для каждого кредита, выданного в этом году, вывести количество дней, когда он
находился в просрочке (если кредит не имел просрочки, то по таким кредитам выводить
значение 0);

**2.** Для каждого кредита вывести актуальный статус (с максимальной датой **calculation_date**).
Написать 2 варианта решения – с использованием оконной функции и
без неё;

**3.** Разработчик случайно сделал **update** таблицы **credit_calculations** таким образом, что поля **credit_id** и **calculation_date** остались корректными, а поле **status** стало частично пустым (**null**). Требуется написать запрос, показывающий количество кредитов, по которым стали пустыми все статусы - вывести количество таких кредитов.

**Решение**:
[SQL-запросы для решения второй задачи](https://github.com/vncvtkv/PSB_SQL_test/blob/dev/scripts/psb_2.sql)

## Задача 3
Есть таблица **employee (id, hire_date, chief_id, salary)** со списком **id** сотрудников, их датой приёма на работу, **id** начальника (такой же сотрудник в таблице) и зарплатой.

**Необходимо**:

**1.** Посчитать количество сотрудников, которые работают в компании дольше, чем их
непосредственные начальники;

**2.** Проверить, есть ли дублирующиеся строки по сотруднику **(id)** в таблице **employee** –
вывести пример такого сотрудника.

**Решение**:
[SQL-запросы для решения третьей задачи](https://github.com/vncvtkv/PSB_SQL_test/blob/dev/scripts/psb_3.sql)

## Задача 4

В банке есть 2 таблицы:

* Транзакции клиентов (могут быть как в рублях, так и в евро и долларах):
**transactions (id, transaction_date, client_id, currency, amount)**;
* Ежедневный курс ЦБ евро и доллара к рублю: **currency (id, currency_date, currency, value)**.

**Необходимо** :

**1.** Вычислить стоимость всех покупок для каждого клиента, результат посчитать в рублях (клиент 1, сумма всех покупок), (клиент 2, сумма всех покупок);

**2.** Вычислить стоимость всех покупок в рублях для каждого клиента в ситуации, когда курс ЦБ есть не на все даты (в таблице валют отсутствует строка с датой). На праздники и выходные устанавливается курс ЦБ в крайний рабочий день перед ними.
(клиент 1, сумма всех покупок), (клиент 2, сумма всех покупок).

**Решение**:
[SQL-запросы для решения четвертой задачи](https://github.com/vncvtkv/PSB_SQL_test/blob/dev/scripts/psb_4.sql)